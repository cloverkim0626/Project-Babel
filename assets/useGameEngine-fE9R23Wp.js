import{r as c,u as _}from"./index-DAzHI3n1.js";import{s as o}from"./supabase-DQQ9Tr4x.js";const S=()=>{const[s,v]=c.useState(null),[m,d]=c.useState(!0),f=_();c.useEffect(()=>{(async()=>{const{data:{session:l}}=await o.auth.getSession();l?.user?await p(l.user.id):d(!1)})();const{data:{subscription:i}}=o.auth.onAuthStateChange(async(l,g)=>{l==="SIGNED_IN"&&g?await p(g.user.id):l==="SIGNED_OUT"&&(v(null),f("/login"))});return()=>i.unsubscribe()},[f]);const p=async x=>{try{const{data:i,error:l}=await o.from("users").select("*").eq("id",x).single();l?console.error("Error fetching profile:",l):i&&v({id:i.id,nickname:i.nickname||"Unknown",classType:i.class_type||"Challenger",role:i.role||"student",level:i.level||1,xp:i.xp||0,points:i.points||0})}catch(i){console.error("Profile fetch failed:",i)}finally{d(!1)}},w=async()=>{await o.auth.signOut()};return{user:s,role:s?.role||"student",loading:m,signOut:w,isAuthenticated:!!s}},X=()=>{const{user:s}=S(),[v,m]=c.useState({level:1,xp:0,nextLevelXp:100,maxHp:100}),[d,f]=c.useState(0),[p,w]=c.useState([]),[x,i]=c.useState([]);c.useEffect(()=>{if(!s)return;(async()=>{const{data:e}=await o.from("users").select("*").eq("id",s.id).single();if(e){const r=Math.floor(100*Math.pow(1.2,e.level-1));m({level:e.level,xp:e.xp,nextLevelXp:r,maxHp:e.max_hp}),f(e.points)}const{data:a}=await o.from("incorrect_answers").select("*").eq("user_id",s.id);a&&w(a.map(r=>({id:r.id,word:r.word,nextReview:r.next_review_at,level:r.repetition_level})));let n=o.from("refund_requests").select("*").order("created_at",{ascending:!1});s.role==="student"?n=n.eq("user_id",s.id):n=n.eq("status","pending");const{data:u}=await n;u&&i(u.map(r=>({id:r.id,user:"Unknown",amount:r.amount,status:r.status,date:r.created_at})))})()},[s]);const l=async(t,e,a,n)=>{s&&await o.from("users").update({level:t,xp:e,max_hp:a,points:n}).eq("id",s.id)};return{levelSpecs:v,points:d,addXp:t=>{m(e=>{let a=e.xp+t,n=e.level,u=e.maxHp,r=e.nextLevelXp;for(;a>=r;)a-=r,n++,u+=10,r=Math.floor(r*1.2),alert(`ðŸŽ‰ LEVEL UP! You are now Level ${n}.`);return l(n,a,u,d),{level:n,xp:a,nextLevelXp:r,maxHp:u}})},addPoints:t=>{f(e=>{const a=e+t;return s&&o.from("users").update({points:a}).eq("id",s.id).then(),a})},logError:async t=>{if(!s)return;const e=new Date(Date.now()+6e4).toISOString(),n={id:crypto.randomUUID(),word:t,nextReview:e,level:0};w(r=>[...r,n]);const{error:u}=await o.from("incorrect_answers").insert({user_id:s.id,word:t,error_type:"meaning",next_review_at:e,repetition_level:0});u&&console.error("Failed to log error:",u)},getDueRevives:()=>{const t=new Date().toISOString();return p.filter(e=>e.nextReview<=t)},clearRevive:async t=>{p.find(a=>a.id===t)&&(w(a=>a.filter(n=>n.id!==t)),s&&await o.from("incorrect_answers").delete().eq("id",t))},incorrectVault:p,requestRefund:async t=>{if(d<t){alert("Insufficient Points!");return}s&&(f(e=>e-t),alert("Refund Request Sent!"),await o.from("users").update({points:d-t}).eq("id",s.id),await o.from("refund_requests").insert({user_id:s.id,amount:t}))},refundRequests:x,processRefund:async(t,e)=>{await o.from("refund_requests").update({status:e?"approved":"rejected"}).eq("id",t),i(a=>a.map(n=>n.id!==t?n:{...n,status:e?"approved":"rejected"}))}}};export{X as a,S as u};
